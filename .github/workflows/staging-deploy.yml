name: Deploy Brezel.ai API to Staging

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [closed]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKER_COMPOSE_FILE: docker-compose.staging.yaml
  CONTAINER_NAME: google-maps-scraper-brezel-api-1

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: |
          go mod download
          go mod verify

      - name: Run tests
        run: |
          go test -v -race ./...

      - name: Build application
        run: |
          go build -o brezel-api .

  build-and-push:
    name: Build and Push Docker Image
    needs: [test]
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') && 
      (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true))
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Go version in Dockerfile
        run: |
          # No changes needed - Dockerfile already uses Go 1.24
          echo "Dockerfile Go version:"
          grep "FROM golang" Dockerfile
          echo "go.mod version:"
          grep "^go " go.mod

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=${{ github.ref_name }}-
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/develop' }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            VERSION=${{ github.ref_name }}

  deploy-staging:
    name: Deploy to Staging Environment
    needs: [build-and-push]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: http://64.226.112.104:8080
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            set -e
            
            echo "Starting deployment to staging server"
            echo "Time: $(date)"
            echo "User: $(whoami)"
            
            # Navigate to backend directory
            cd /home/${{ secrets.STAGING_USER }}/google-maps-scraper || {
              echo "ERROR: Backend directory not found"
              exit 1
            }
            
            # Pull latest code
            echo "Pulling latest backend code from develop branch..."
            git fetch origin
            git checkout develop
            git pull origin develop
            
            # Check for frontend (optional)
            echo "Checking for frontend application..."
            FRONTEND_DIR="../scraper-webapp"
            if [ ! -d "$FRONTEND_DIR" ]; then
              FRONTEND_DIR="../google-maps-scraper-webapp"
            fi
            
            if [ -d "$FRONTEND_DIR" ]; then
              echo "Found frontend at: $FRONTEND_DIR"
              cd "$FRONTEND_DIR"
              git fetch origin
              git checkout develop || git checkout main
              git pull
              cd /home/${{ secrets.STAGING_USER }}/google-maps-scraper
            else
              echo "Frontend directory not found, proceeding with backend only"
            fi
            
            # Setup environment
            echo "Configuring environment variables..."
            if [ ! -f ".env" ]; then
              echo "No .env file found, creating from template..."
              cp .env.example .env
            fi
            
            # Backup current configuration
            cp .env .env.backup
            
            # Fix Docker networking for Linux
            sed -i 's/host\.docker\.internal/172.17.0.1/g' .env
            
            # Update passwords from GitHub secrets
            if [ ! -z "${{ secrets.STAGING_POSTGRES_PASSWORD }}" ]; then
              echo "Updating database password..."
              sed -i "s/^POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=${{ secrets.STAGING_POSTGRES_PASSWORD }}/" .env
              sed -i "s/scraper:strongpassword/scraper:${{ secrets.STAGING_POSTGRES_PASSWORD }}/" .env
            fi
            
            if [ ! -z "${{ secrets.STAGING_CLERK_API_KEY }}" ]; then
              echo "Updating Clerk API key..."
              sed -i "s/^CLERK_API_KEY=.*/CLERK_API_KEY=${{ secrets.STAGING_CLERK_API_KEY }}/" .env
            fi
            
            # Set concurrency for single-core servers
            CPU_CORES=$(nproc)
            echo "Server has $CPU_CORES CPU cores"
            if [ $CPU_CORES -eq 1 ]; then
              echo "Configuring for single-core performance..."
              if grep -q "^CONCURRENCY=" .env; then
                sed -i "s/^CONCURRENCY=.*/CONCURRENCY=1/" .env
              else
                echo "CONCURRENCY=1" >> .env
              fi
            fi
            
            # Build Docker image
            echo "Building backend Docker image..."
            docker build --no-cache -t brezel-staging-test . || {
              echo "ERROR: Docker build failed"
              echo "First 20 lines of Dockerfile:"
              head -20 Dockerfile
              exit 1
            }
            
            # Build frontend if exists
            if [ -d "$FRONTEND_DIR" ]; then
              echo "Building frontend Docker image..."
              if [ ! -f "$FRONTEND_DIR/.env.staging" ]; then
                if [ -f "$FRONTEND_DIR/.env.example" ]; then
                  cp "$FRONTEND_DIR/.env.example" "$FRONTEND_DIR/.env.staging"
                fi
                echo "NEXT_PUBLIC_API_URL=http://localhost:8080" >> "$FRONTEND_DIR/.env.staging"
              fi
              docker build --no-cache -t gmaps-webapp-staging "$FRONTEND_DIR"
            fi
            
            # Stop existing containers
            echo "Stopping current containers..."
            docker compose -f docker-compose.staging.yaml down --remove-orphans || true
            
            # Start containers
            echo "Starting services with docker-compose..."
            docker compose -f docker-compose.staging.yaml --env-file .env up -d
            
            # Wait for startup
            echo "Waiting for services to initialize..."
            sleep 15
            
            # Health check
            echo "Checking backend health status..."
            HEALTH_CHECK_URL="http://localhost:8080/health"
            MAX_ATTEMPTS=30
            
            for i in $(seq 1 $MAX_ATTEMPTS); do
              if curl -s -f $HEALTH_CHECK_URL > /dev/null 2>&1; then
                echo "Backend is running and healthy"
                echo ""
                echo "Deployment completed successfully"
                echo "Backend API: http://64.226.112.104:8080"
                echo "Health endpoint: http://64.226.112.104:8080/health"
                echo "API documentation: http://64.226.112.104:8080/api/docs"
                if [ -d "$FRONTEND_DIR" ]; then
                  echo "Frontend application: http://64.226.112.104:3000"
                fi
                echo ""
                echo "Running containers:"
                docker ps | grep -E "(brezel|gmaps)" || true
                exit 0
              else
                echo "Health check attempt $i of $MAX_ATTEMPTS - Backend not ready yet"
                if [ $i -eq $MAX_ATTEMPTS ]; then
                  echo "ERROR: Backend failed to start after $MAX_ATTEMPTS attempts"
                  echo ""
                  echo "Container logs:"
                  docker compose -f docker-compose.staging.yaml logs --tail 100
                  exit 1
                fi
                sleep 3
              fi
            done

      - name: Run smoke tests
        if: success()
        run: |
          sleep 5
          echo "Running basic API tests..."
          
          # Test health endpoint
          echo "Testing health endpoint..."
          curl -f -s http://64.226.112.104:8080/health || {
            echo "Health check failed"
            exit 1
          }
          
          echo "All tests passed successfully"

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const message = status === 'success' 
              ? 'Successfully deployed to staging environment' 
              : 'Deployment to staging failed';
            
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status === 'success' ? 'success' : 'failure',
              description: message,
              context: 'Staging Deployment'
            });